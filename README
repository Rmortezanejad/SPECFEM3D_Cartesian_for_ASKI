####################################################
THIS IS A VERY SHORT DOCUMENTATION ON HOW TO GET
STARTED WITH

  SPECFEM3D_Cartesian_3.0  for  ASKI - version 1.0

####################################################

SPECFEM3D for ASKI, as well as ASKI and some of its components, documentation 
and examples are available via http://www.rub.de/aski
Please also refer to this address in case you want to get in touch with the
authors, who are very eager on any feedback, especially about problems you may 
encounter installing or using the software.

The main authors are Florian Schumacher (Ruhr-University Bochum, Germany)
and Wolfgang Friederich (Ruhr-University Bochum, Germany), 2015.

SPECFEM3D_Cartesian version 3.0 and ASKI version 1.0 are free software: 
you can redistribute it and/or modify it under the terms of the GNU 
General Public License as published by the Free Software Foundation, 
either version 2 of the License, or (at your option) any later version.
SPECFEM3D_Cartesian version 3.0 and ASKI version 1.0 are distributed in 
the hope that they will be useful, but WITHOUT ANY WARRANTY; without 
even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR 
PURPOSE.  See the GNU General Public License for more details.
You should have received a copy of the GNU General Public License
along with SPECFEM3D_Cartesian version 3.0 and ASKI version 1.0.
If not, see <http://www.gnu.org/licenses/>.


##########
REQUIREMENTS
##########
1) You need a working installation of the SPECFEM3D_Cartesian code, including 
   modifications for usage with ASKI:

-> You can either download and install the modified SPECFEM3D version 
   SPECFEM3D_Cartesian_git_master_2015-11-07_extended_for_ASKI.tar.gz, available via 
   http://www.rub.de/aski, which already includes modifications for ASKI,
-> OR use your running installation of SPECFEM3D_Cartesian and extend it for usage 
   with ASKI, as described below (item "EXTEND REGULAR SPECFEM3D"). Also refer to 
   the manual SPECFEM3D_Cartesian_for_ASKI_manual.pdf

   IN BOTH CASES YOU STILL MUST INSTALL THIS PACKAGE 
   SPECFEM3D_Cartesian_for_ASKI_1.0.tar.gz (item "INSTALL", below).

2) You need basic experience in using the regular SPECFEM3D_Cartesian software!

3) Also you require an installation of the ASKI 1.0 main package (available via 
   http://www.rub.de/aski). The ASKI installation directory will be referred to 
   below as "ASKI_1.0/"


##########
DOWNLOAD AND EXTRACT TAR BALL
##########
You should have downloaded the tar ball SPECFEM3D_Cartesian_for_ASKI_1.0.tar.gz 
from http://www.rub.de/aski . Please extract it in such a way, that the directory 
SPECFEM3D_Cartesian_for_ASKI is contained in the ASKI installation directory 
ASKI_1.0/


##########
USAGE, DOCUMENTATION
##########
read the documentation SPECFEM3D_Cartesian_for_ASKI_manual.pdf, avaliable via 
http://www.rub.de/aski for information on how to set parameters correctly and how 
to use SPECFEM3D as a forward solver for ASKI.


##########
INSTALLATION
##########
You need to compile few more ASKI binaries:
+ in ASKI_1.0/SPECFEM3D_Cartesian_for_ASKI/Makefile , set COMPILER appropriately, 
   adjust FFLAGS if required and set the variables BLAS, LAPACK, just as you did 
   for installing main package ASKI_1.0
+ issue the command
      make all
   from directory ASKI_1.0/SPECFEM3D_Cartesian_for_ASKI/
After that, ASKI_1.0/bin should contain the new binaries.


##########
EXTEND REGULAR SPECFEM3D
##########
If you have a regular SPECFEM3D_Cartesian installation which has the required 
functionality, you may modify your installation for usage with ASKI in the following way.
This procedure was tested for SPECFEM3D_Cartesian git master by 7 Nov 2015, extended by 
two important modifications which were commited to the devel branch on 3 september 2015, 
or are about to be commited by the developers team:
1) src/specfem3D/setup_sources_receivers.f90 , subroutine
setup_sources(), l.180 :
   removing "USE_FORCE_POINT_SOURCE .or." from the if-clause, i.e. execute
   (re)definition of t0 only in case of USE_RICKER_TIME_FUNCTION == .true.
2) src/specfem3D/compute_add_sources_viscoelastic.f90 :
   always call function comp_source_time_function_gauss() with half duration
   hdur_gaussian(isource) instead of fixed value of 5.d0*DT
If your regular SPECFEM3D_Cartesian installation has this functionality, you can 
extend it for ASKI by the following 12 steps:

1) install SPECFEM3D_Cartesian on your system and make it run, gain 
   experience in using it (below, the installation path is refered to as 
   "SPECFEM3D/")

2) copy file ASKI_1.0/SPECFEM3D_Cartesian_for_ASKI/specfem3D_for_ASKI.f90 to 
   SPECFEM3D/src/specfem3D/

3) replace file SPECFEM3D/src/generate_databases/model_external_values.f90 by 
   ASKI_1.0/SPECFEM3D_Cartesian_for_ASKI/model_external_values.f90

4) append content of file ASKI_1.0/SPECFEM3D_Cartesian_for_ASKI/parallel_ASKI.f90 
   to file SPECFEM3D/src/shared/parallel.f90

5) append content of file ASKI_1.0/SPECFEM3D_Cartesian_for_ASKI/specfem3D_par_ASKI.f90 
   to file SPECFEM3D/src/specfem3D/specfem3D_par.f90

6) in SPECFEM3D/src/specfem3D/rules.mk : add the following line into the 
   definition of specfem3D_OBJECTS (e.g. before line with "$(EMPTY_MACRO)")
	$O/specfem3D_for_ASKI.spec.o \
   (be aware that the above line MUST start with an actual TAB character in order 
   to conform to the GNU-make syntax)

7) in SPECFEM3D/src/specfem3D/prepare_timerun.F90 in subroutine prepare_timerun :
   add the following line at the end of the subroutine, before the statistics 
   output is written to main output file by rank 0:
      call prepare_timerun_ASKI()

8) in SPECFEM3D/src/specfem3D/iterate_time.F90 in subroutine iterate_time : 
   add the following line just before the "enddo" of the time loop
      call write_ASKI_output()

9) in SPECFEM3D/src/specfem3D/finalize_simulation.f90 in subroutine finalize_simulation : 
   add the following line just before the main output file is closed at the end of the subroutine
      call save_ASKI_output()

10) Set USE_SOURCES_RECVS_Z = .true. in SPECFEM3D/setup/constants.h (or wherever 
    your file constants.h is located).

11) recompile all SPECFEM3D binaries by calling "make" in directory SPECFEM3D/

12) in order to use ASKI in SPECFEM3D simulations, copy file 
    ASKI_1.0/SPECFEM3D_Cartesian_for_ASKI/Par_file_ASKI to your respective DATA/ path
    (which is e.g. SPECFEM3D/EXAMPLES/my_example/DATA/ , or SPECFEM3D/DATA/ ). This 
    file must be adjusted for any specific simulation (just as all other parameter files), 
    refer to documentation or examples on how to use it.

Additionally, you may refer to the manual SPECFEM3D_Cartesian_for_ASKI_manual.pdf 
for any further details on extending a regular SPECFEM3D code copy for use with ASKI.
